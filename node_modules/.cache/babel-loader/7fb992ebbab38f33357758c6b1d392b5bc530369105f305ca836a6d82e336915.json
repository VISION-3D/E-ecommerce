{"ast":null,"code":"import { resize, frame, cancelFrame, frameData } from 'motion-dom';\nimport { noop } from 'motion-utils';\nimport { createScrollInfo } from './info.mjs';\nimport { createOnScrollHandler } from './on-scroll-handler.mjs';\nconst scrollListeners = new WeakMap();\nconst resizeListeners = new WeakMap();\nconst onScrollHandlers = new WeakMap();\nconst scrollSize = new WeakMap();\nconst dimensionCheckProcesses = new WeakMap();\nconst getEventTarget = element => element === document.scrollingElement ? window : element;\nfunction scrollInfo(onScroll, {\n  container = document.scrollingElement,\n  trackContentSize = false,\n  ...options\n} = {}) {\n  if (!container) return noop;\n  let containerHandlers = onScrollHandlers.get(container);\n  /**\n   * Get the onScroll handlers for this container.\n   * If one isn't found, create a new one.\n   */\n  if (!containerHandlers) {\n    containerHandlers = new Set();\n    onScrollHandlers.set(container, containerHandlers);\n  }\n  /**\n   * Create a new onScroll handler for the provided callback.\n   */\n  const info = createScrollInfo();\n  const containerHandler = createOnScrollHandler(container, onScroll, info, options);\n  containerHandlers.add(containerHandler);\n  /**\n   * Check if there's a scroll event listener for this container.\n   * If not, create one.\n   */\n  if (!scrollListeners.has(container)) {\n    const measureAll = () => {\n      for (const handler of containerHandlers) {\n        handler.measure(frameData.timestamp);\n      }\n      frame.preUpdate(notifyAll);\n    };\n    const notifyAll = () => {\n      for (const handler of containerHandlers) {\n        handler.notify();\n      }\n    };\n    const listener = () => frame.read(measureAll);\n    scrollListeners.set(container, listener);\n    const target = getEventTarget(container);\n    window.addEventListener(\"resize\", listener, {\n      passive: true\n    });\n    if (container !== document.documentElement) {\n      resizeListeners.set(container, resize(container, listener));\n    }\n    target.addEventListener(\"scroll\", listener, {\n      passive: true\n    });\n    listener();\n  }\n  /**\n   * Enable content size tracking if requested and not already enabled.\n   */\n  if (trackContentSize && !dimensionCheckProcesses.has(container)) {\n    const listener = scrollListeners.get(container);\n    // Store initial scroll dimensions (object is reused to avoid allocation)\n    const size = {\n      width: container.scrollWidth,\n      height: container.scrollHeight\n    };\n    scrollSize.set(container, size);\n    // Add frame-based scroll dimension checking to detect content changes\n    const checkScrollDimensions = () => {\n      const newWidth = container.scrollWidth;\n      const newHeight = container.scrollHeight;\n      if (size.width !== newWidth || size.height !== newHeight) {\n        listener();\n        size.width = newWidth;\n        size.height = newHeight;\n      }\n    };\n    // Schedule with keepAlive=true to run every frame\n    const dimensionCheckProcess = frame.read(checkScrollDimensions, true);\n    dimensionCheckProcesses.set(container, dimensionCheckProcess);\n  }\n  const listener = scrollListeners.get(container);\n  frame.read(listener, false, true);\n  return () => {\n    cancelFrame(listener);\n    /**\n     * Check if we even have any handlers for this container.\n     */\n    const currentHandlers = onScrollHandlers.get(container);\n    if (!currentHandlers) return;\n    currentHandlers.delete(containerHandler);\n    if (currentHandlers.size) return;\n    /**\n     * If no more handlers, remove the scroll listener too.\n     */\n    const scrollListener = scrollListeners.get(container);\n    scrollListeners.delete(container);\n    if (scrollListener) {\n      getEventTarget(container).removeEventListener(\"scroll\", scrollListener);\n      resizeListeners.get(container)?.();\n      window.removeEventListener(\"resize\", scrollListener);\n    }\n    // Clean up scroll dimension checking\n    const dimensionCheckProcess = dimensionCheckProcesses.get(container);\n    if (dimensionCheckProcess) {\n      cancelFrame(dimensionCheckProcess);\n      dimensionCheckProcesses.delete(container);\n    }\n    scrollSize.delete(container);\n  };\n}\nexport { scrollInfo };\n//# sourceMappingURL=track.mjs.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}